Una compañera subio estos cambios:
From d8707f8677f4217bab83d7375a19525aef2a7bc6 Mon Sep 17 00:00:00 2001
From: chandiler <lan767228@gmail.com>
Date: Sat, 22 Nov 2025 18:32:42 -0500
Subject: [PATCH] Add automatic audit logging in DB session layer

---
 app/db/base.py              |  18 +++----
 app/db/sql.py               | 102 +++++++++++++++++++++++++++++-------
 app/modules/log.py          |  31 +++++++++++
 app/modules/users/models.py |  37 ++++++++++---
 init_db.py                  |  19 +++++++
 5 files changed, 171 insertions(+), 36 deletions(-)
 create mode 100644 app/modules/log.py
 create mode 100644 init_db.py

diff --git a/app/db/base.py b/app/db/base.py
index cb6075c..d3df220 100644
--- a/app/db/base.py
+++ b/app/db/base.py
@@ -11,33 +11,31 @@
 
 class Base(DeclarativeBase):
     """Declarative base for all ORM models."""
+
     pass
 
 
 class UUIDPKMixin:
     """Primary Key UUID (v4) estándar para todas las tablas."""
-    id: Mapped[uuid.UUID] = mapped_column(
-        default=uuid.uuid4,
-        primary_key=True
-    )
+
+    id: Mapped[uuid.UUID] = mapped_column(default=uuid.uuid4, primary_key=True)
 
 
 class TimestampMixin:
     """Timestamps automáticos (server-side)."""
+
     created_at: Mapped[dt.datetime] = mapped_column(
-        nullable=False,
-        server_default=func.now()
+        nullable=False, server_default=func.now()
     )
     updated_at: Mapped[dt.datetime] = mapped_column(
-        nullable=False,
-        server_default=func.now(),
-        onupdate=func.now()
+        nullable=False, server_default=func.now(), onupdate=func.now()
     )
 
 
 class ReprMixin:
     """__repr__ útil para debug/logging."""
-    def __repr__(self) -> str:  
+
+    def __repr__(self) -> str:
         cols: list[str] = []
         for k in getattr(self, "__mapper__").c.keys():
             v: Any = getattr(self, k, None)
diff --git a/app/db/sql.py b/app/db/sql.py
index 7cd6633..0cfa3a1 100644
--- a/app/db/sql.py
+++ b/app/db/sql.py
@@ -1,19 +1,28 @@
 # app/db/sql.py
 from __future__ import annotations
 
-from contextlib import asynccontextmanager
-
+from fastapi import Request
 from sqlalchemy.ext.asyncio import (
     AsyncSession,
     async_sessionmaker,
     create_async_engine,
 )
-from sqlalchemy import text
+from sqlalchemy import text, insert
+from app.core.config import settings
 
 from app.core.config import settings
+from app.modules.users.models import AuditLog
+
+# from app.dependencies import get_current_user  # <-- import the user resolver
+
+
+async def write_audit_log(session, user_id, action, details):
+    stmt = insert(AuditLog).values(user_id=user_id, action=action, details=details)
+    await session.execute(stmt)
+
 
 engine = create_async_engine(
-    settings.SQL_DSN,                
+    settings.SQL_DSN,
     echo=settings.DB_ECHO,
     pool_size=settings.DB_POOL_SIZE,
     max_overflow=settings.DB_MAX_OVERFLOW,
@@ -28,47 +37,104 @@
     class_=AsyncSession,
 )
 
-@asynccontextmanager
-async def session_scope() -> AsyncSession:
+
+# @asynccontextmanager
+# async def session_scope() -> AsyncSession:
+#     """
+#     Context manager for transactional operations.
+#     Handles commit/rollback and session closure.
+#     """
+#     async with AsyncSessionLocal() as session:
+#         try:
+#             yield session
+#             await session.commit()
+#         except Exception:
+#             await session.rollback()
+#             raise
+
+# async def get_session() -> AsyncSession:
+#     async with AsyncSessionLocal() as session:
+#         try:
+#             yield session
+#             await session.commit()
+#         except Exception:
+#             await session.rollback()
+#             raise
+
+
+async def get_session(request: Request) -> AsyncSession:
     """
-    Context manager for transactional operations.
-    Handles commit/rollback and session closure.
+    Provide a DB session for each request.
+    Automatically apply commit/rollback and write audit logs.
     """
+
+    # Lazy import to avoid circular import
+    from app.dependencies import get_current_user
+
     async with AsyncSessionLocal() as session:
+        user_id = None
+
+        # Resolve user from JWT (if available)
         try:
-            yield session
-            await session.commit()
+            token = request.headers.get("Authorization", "").replace("Bearer ", "")
+            user = await get_current_user(token=token, session=session)
+            if user:
+                user_id = user.id
         except Exception:
-            await session.rollback()
-            raise
+            pass
+
+        action = f"{request.method} {request.url.path}"
 
-async def get_session() -> AsyncSession:
-    async with AsyncSessionLocal() as session:
         try:
             yield session
+
             await session.commit()
-        except Exception:
+
+            await session.execute(
+                insert(AuditLog).values(
+                    user_id=user_id,
+                    action=f"{action} COMMIT",
+                    details="Operation completed successfully",
+                )
+            )
+            await session.commit()
+
+        except Exception as exc:
+
             await session.rollback()
+
+            await session.execute(
+                insert(AuditLog).values(
+                    user_id=user_id,
+                    action=f"{action} ROLLBACK",
+                    details=str(exc),
+                )
+            )
+            await session.commit()
+
             raise
 
+
 async def ping_db() -> bool:
     async with AsyncSessionLocal() as session:
         await session.execute(text("SELECT 1"))
         return True
 
+
 async def init_db():
     """
     Initialize database tables
     """
     from sqlalchemy.ext.declarative import declarative_base
+
     Base = declarative_base()
-    
+
     # Import all models here so they get registered
     try:
         from app import models  # This imports all models
     except ImportError:
         # If no models are defined yet, continue
         pass
-    
+
     async with engine.begin() as conn:
-        await conn.run_sync(Base.metadata.create_all)
\ No newline at end of file
+        await conn.run_sync(Base.metadata.create_all)
diff --git a/app/modules/log.py b/app/modules/log.py
new file mode 100644
index 0000000..27ab2c9
--- /dev/null
+++ b/app/modules/log.py
@@ -0,0 +1,31 @@
+from __future__ import annotations
+
+from sqlalchemy import insert
+from sqlalchemy.ext.asyncio import AsyncSession
+
+from app.modules.users.models import AuditLog
+
+
+async def write_audit_log(
+    session: AsyncSession,
+    user_id: str | None,
+    action: str,
+    details: str | None = None,
+):
+    """
+    Write an audit log entry.
+
+    action:
+        "REGISTER"
+        "CREATE_APPOINTMENT"
+        "UPDATE_PATIENT"
+        "DELETE_USER"
+
+    details:
+    """
+    stmt = insert(AuditLog).values(
+        user_id=user_id,
+        action=action,
+        details=details,
+    )
+    await session.execute(stmt)
diff --git a/app/modules/users/models.py b/app/modules/users/models.py
index dddd5c9..ca2beed 100644
--- a/app/modules/users/models.py
+++ b/app/modules/users/models.py
@@ -4,6 +4,9 @@
 import uuid
 from typing import Optional
 from enum import Enum as PyEnum
+from sqlalchemy import ForeignKey
+import datetime as dt
+from sqlalchemy import func
 
 from sqlalchemy import (
     String,
@@ -16,11 +19,25 @@
 
 from app.db.base import Base, UUIDPKMixin, TimestampMixin, ReprMixin
 
+
+class AuditLog(Base):
+    __tablename__ = "audit_logs"
+
+    id: Mapped[uuid.UUID] = mapped_column(primary_key=True, default=uuid.uuid4)
+    user_id: Mapped[uuid.UUID | None] = mapped_column(
+        ForeignKey("users.id"), nullable=True
+    )
+    action: Mapped[str] = mapped_column(nullable=False)
+    details: Mapped[str | None] = mapped_column()
+    timestamp: Mapped[dt.datetime] = mapped_column(server_default=func.now())
+
+
 class UserRole(PyEnum):
     PATIENT = "patient"
     DOCTOR = "doctor"
     ADMIN = "admin"
 
+
 class User(UUIDPKMixin, TimestampMixin, ReprMixin, Base):
     __tablename__ = "users"
 
@@ -40,18 +57,22 @@ class User(UUIDPKMixin, TimestampMixin, ReprMixin, Base):
     phone: Mapped[Optional[str]] = mapped_column(String(32), nullable=True)
 
     role: Mapped[str] = mapped_column(
-        String(20), 
-        nullable=False, 
-        server_default=UserRole.PATIENT.value
+        String(20), nullable=False, server_default=UserRole.PATIENT.value
+    )
+
+    is_active: Mapped[bool] = mapped_column(
+        Boolean, nullable=False, server_default="true"
+    )
+    email_verified: Mapped[bool] = mapped_column(
+        Boolean, nullable=False, server_default="false"
     )
-    
-    is_active: Mapped[bool] = mapped_column(Boolean, nullable=False, server_default="true")
-    email_verified: Mapped[bool] = mapped_column(Boolean, nullable=False, server_default="false")
 
     __table_args__ = (
         UniqueConstraint("email", name="uq_users_email"),
         CheckConstraint("email = lower(email)", name="ck_users_email_lowercase"),
-        CheckConstraint("role IN ('patient', 'doctor', 'admin')", name="ck_users_role_valid"),
+        CheckConstraint(
+            "role IN ('patient', 'doctor', 'admin')", name="ck_users_role_valid"
+        ),
         Index("ix_users_role", "role"),
         Index("ix_users_active_role", "is_active", "role"),
     )
@@ -64,4 +85,4 @@ def role_enum(self) -> UserRole:
     @role_enum.setter
     def role_enum(self, value: UserRole):
         """Set role from UserRole enum instance."""
-        self.role = value.value
\ No newline at end of file
+        self.role = value.value
diff --git a/init_db.py b/init_db.py
new file mode 100644
index 0000000..fd3af59
--- /dev/null
+++ b/init_db.py
@@ -0,0 +1,19 @@
+# init_db.py
+import asyncio
+from app.db.sql import engine
+from app.db.base import Base
+
+# IMPORTANT: import all models so that Base.metadata knows them
+from app.modules.users import models as users_models
+
+
+async def init_models():
+    async with engine.begin() as conn:
+        await conn.run_sync(Base.metadata.drop_all)
+        await conn.run_sync(Base.metadata.create_all)
+
+    print("Database schema recreated successfully!")
+
+
+if __name__ == "__main__":
+    asyncio.run(init_models())
Ahora veo este error:
(venv) christianrm@Christians-MacBook-Air MedBookDB % uvicorn app.main:app --reload
INFO:     Will watch for changes in these directories: ['/Users/christianrm/Repositories/MedBookDB']
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [15969] using WatchFiles
INFO:     Started server process [15971]
INFO:     Waiting for application startup.
INFO:     Application startup complete.
INFO:     127.0.0.1:52818 - "GET / HTTP/1.1" 200 OK
INFO:     127.0.0.1:52819 - "GET /docs HTTP/1.1" 200 OK
INFO:     127.0.0.1:52819 - "GET /openapi.json HTTP/1.1" 200 OK
INFO:     127.0.0.1:52820 - "GET /api/patients?limit=20&offset=0&order_by=created_at&order_dir=desc HTTP/1.1" 500 Internal Server Error
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "/Users/christianrm/Repositories/MedBookDB/app/db/sql.py", line 89, in get_session
    yield session
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/fastapi/routing.py", line 111, in app
    response = await f(request)
               ^^^^^^^^^^^^^^^^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/fastapi/routing.py", line 381, in app
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<6 lines>...
    )
    ^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/fastapi/dependencies/utils.py", line 612, in solve_dependencies
    solved_result = await solve_dependencies(
                    ^^^^^^^^^^^^^^^^^^^^^^^^^
    ...<9 lines>...
    )
    ^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/fastapi/dependencies/utils.py", line 641, in solve_dependencies
    solved = await call(**solved_result.values)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/fastapi/security/oauth2.py", line 494, in __call__
    raise HTTPException(
    ...<3 lines>...
    )
fastapi.exceptions.HTTPException: 401: Not authenticated

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/psycopg/cursor_async.py", line 97, in execute
    raise ex.with_traceback(None)
psycopg.errors.UndefinedTable: relation "audit_logs" does not exist
LINE 1: INSERT INTO audit_logs (id, user_id, action, details) VALUES...
                    ^

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/uvicorn/protocols/http/httptools_impl.py", line 409, in run_asgi
    result = await app(  # type: ignore[func-returns-value]
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
        self.scope, self.receive, self.send
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/uvicorn/middleware/proxy_headers.py", line 60, in __call__
    return await self.app(scope, receive, send)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/fastapi/applications.py", line 1134, in __call__
    await super().__call__(scope, receive, send)
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/starlette/applications.py", line 113, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 186, in __call__
    raise exc
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/starlette/middleware/errors.py", line 164, in __call__
    await self.app(scope, receive, _send)
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/starlette/middleware/exceptions.py", line 63, in __call__
    await wrap_app_handling_exceptions(self.app, conn)(scope, receive, send)
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/fastapi/middleware/asyncexitstack.py", line 18, in __call__
    await self.app(scope, receive, send)
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/starlette/routing.py", line 716, in __call__
    await self.middleware_stack(scope, receive, send)
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/starlette/routing.py", line 736, in app
    await route.handle(scope, receive, send)
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/starlette/routing.py", line 290, in handle
    await self.app(scope, receive, send)
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/fastapi/routing.py", line 125, in app
    await wrap_app_handling_exceptions(app, request)(scope, receive, send)
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 53, in wrapped_app
    raise exc
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/starlette/_exception_handler.py", line 42, in wrapped_app
    await app(scope, receive, sender)
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/fastapi/routing.py", line 107, in app
    async with AsyncExitStack() as request_stack:
               ~~~~~~~~~~~~~~^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 768, in __aexit__
    raise exc
  File "/opt/homebrew/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 751, in __aexit__
    cb_suppress = await cb(*exc_details)
                  ^^^^^^^^^^^^^^^^^^^^^^
  File "/opt/homebrew/Cellar/python@3.13/3.13.7/Frameworks/Python.framework/Versions/3.13/lib/python3.13/contextlib.py", line 235, in __aexit__
    await self.gen.athrow(value)
  File "/Users/christianrm/Repositories/MedBookDB/app/db/sql.py", line 106, in get_session
    await session.execute(
    ...<5 lines>...
    )
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/ext/asyncio/session.py", line 449, in execute
    result = await greenlet_spawn(
             ^^^^^^^^^^^^^^^^^^^^^
    ...<6 lines>...
    )
    ^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 201, in greenlet_spawn
    result = context.throw(*sys.exc_info())
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 2351, in execute
    return self._execute_internal(
           ~~~~~~~~~~~~~~~~~~~~~~^
        statement,
        ^^^^^^^^^^
    ...<4 lines>...
        _add_event=_add_event,
        ^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/orm/session.py", line 2249, in _execute_internal
    result: Result[Any] = compile_state_cls.orm_execute_statement(
                          ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self,
        ^^^^^
    ...<4 lines>...
        conn,
        ^^^^^
    )
    ^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/orm/bulk_persistence.py", line 1306, in orm_execute_statement
    result = conn.execute(
        statement, params or {}, execution_options=execution_options
    )
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1419, in execute
    return meth(
        self,
        distilled_parameters,
        execution_options or NO_OPTIONS,
    )
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/sql/elements.py", line 526, in _execute_on_connection
    return connection._execute_clauseelement(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        self, distilled_params, execution_options
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1641, in _execute_clauseelement
    ret = self._execute_context(
        dialect,
    ...<8 lines>...
        cache_hit=cache_hit,
    )
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1846, in _execute_context
    return self._exec_single_context(
           ~~~~~~~~~~~~~~~~~~~~~~~~~^
        dialect, context, statement, parameters
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1986, in _exec_single_context
    self._handle_dbapi_exception(
    ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        e, str_statement, effective_parameters, cursor, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 2355, in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/engine/base.py", line 1967, in _exec_single_context
    self.dialect.do_execute(
    ~~~~~~~~~~~~~~~~~~~~~~~^
        cursor, str_statement, effective_parameters, context
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/engine/default.py", line 951, in do_execute
    cursor.execute(statement, parameters)
    ~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/dialects/postgresql/psycopg.py", line 597, in execute
    result = self.await_(self._cursor.execute(query, params, **kw))
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 132, in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/sqlalchemy/util/_concurrency_py3k.py", line 196, in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
  File "/Users/christianrm/Repositories/MedBookDB/venv/lib/python3.13/site-packages/psycopg/cursor_async.py", line 97, in execute
    raise ex.with_traceback(None)
sqlalchemy.exc.ProgrammingError: (psycopg.errors.UndefinedTable) relation "audit_logs" does not exist
LINE 1: INSERT INTO audit_logs (id, user_id, action, details) VALUES...
                    ^
[SQL: INSERT INTO audit_logs (id, user_id, action, details) VALUES (%(id)s::UUID, %(user_id)s::UUID, %(action)s::VARCHAR, %(details)s::VARCHAR)]
[parameters: {'id': UUID('b67f19f2-39f6-4bcc-9aab-15cefe0125f2'), 'user_id': None, 'action': 'GET /api/patients ROLLBACK', 'details': '401: Not authenticated'}]
(Background on this error at: https://sqlalche.me/e/20/f405)
